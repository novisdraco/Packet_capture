<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced IDS - Real-time Threat Detection</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        /* Base */
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #1f3b74; /* flat bg for performance */
            color: #333;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: #ffffff;
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.06);
            position: sticky; top: 0; z-index: 100;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .header-content {
            max-width: 1400px; margin: 0 auto;
            display: flex; align-items: center; gap: 2rem;
        }
        .logo { display: flex; align-items: center; gap: .75rem; }
        .logo-icon {
            width: 40px; height: 40px; border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: grid; place-items: center; color: #fff; font-weight: 700;
        }
        .logo-text { font-size: 1.5rem; font-weight: 700; color: #2d3748; margin: 0; }

        .status-badge {
            margin-left: auto;
            padding: .5rem 1rem; border-radius: 999px; font-size: .875rem; font-weight: 600;
            display: inline-flex; align-items: center; gap: .5rem;
            background: #f3f4f6; color: #6b7280;
        }
        .status-badge.active { background: #10b981; color: #fff; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; }

        /* Container */
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }

        /* Control Panel */
        .control-panel {
            background: #fff; border-radius: 16px; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem;
            box-shadow: 0 6px 24px rgba(0,0,0,0.06); border: 1px solid #f1f5f9;
        }
        .control-grid {
            display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: center;
        }
        .interface-group { display: flex; flex-direction: column; gap: .5rem; }
        .interface-group label { font-size: .875rem; font-weight: 600; color: #374151; }
        .interface-select {
            padding: .6rem .9rem; border: 1px solid #e5e7eb; border-radius: 10px; min-width: 240px;
            outline: none;
        }
        .btn-group { display: flex; gap: .75rem; }
        .btn {
            padding: .7rem 1.2rem; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;
        }
        .btn:disabled { background: #d1d5db; color: #9ca3af; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; }
        .btn-danger  { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: #fff; }

        /* Stats */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
            gap: 1rem; margin-bottom: 1.25rem;
        }
        .stat-card {
            background: #fff; border-radius: 16px; padding: 1.25rem; text-align: center;
            box-shadow: 0 6px 24px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; position: relative;
        }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); }
        .alert-card::before { background: linear-gradient(90deg, #ef4444 0%, #dc2626 100%); }
        .performance-card::before { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        .stat-number { font-size: 2.1rem; font-weight: 800; color: #1f2937; line-height: 1; }
        .stat-number.alert { color: #ef4444; }
        .stat-number.performance { color: #10b981; }
        .stat-label { color: #6b7280; font-size: .8rem; font-weight: 600; margin-top: .4rem; }

        /* Main grid */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
        .content-card {
            background: #fff; border-radius: 16px; overflow: hidden;
            box-shadow: 0 6px 24px rgba(0,0,0,0.05); border: 1px solid #f1f5f9; display: flex; flex-direction: column; height: 480px;
        }
        .card-header {
            padding: 1rem 1.25rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff; display: flex; align-items: center; gap: .75rem;
        }
        .card-header.alerts { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .card-title { font-size: 1.05rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: .5rem; }
        .card-badge { margin-left: auto; background: rgba(255,255,255,.2); padding: .2rem .6rem; border-radius: 999px; font-size: .75rem; font-weight: 700; }
        .card-content { flex: 1; position: relative; overflow: hidden; }
        .content-list { height: 100%; overflow-y: auto; padding: 0; }
        .content-list::-webkit-scrollbar { width: 6px; }
        .content-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .list-item { padding: 1rem 1.25rem; border-bottom: 1px solid #f1f5f9; }
        .alert-item { border-left: 4px solid #ef4444; background: linear-gradient(90deg, rgba(239,68,68,.05) 0%, transparent 40%); }
        .packet-item { border-left: 4px solid #10b981; }
        .item-header { display: flex; align-items: flex-start; gap: 1rem; }
        .item-title { font-weight: 700; color: #1f2937; margin: 0; font-size: .98rem; }
        .item-time { margin-left: auto; color: #6b7280; font-size: .85rem; white-space: nowrap; }
        .item-details { color: #4b5563; font-size: .88rem; line-height: 1.4; margin: .4rem 0; }
        .item-network { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: .8rem; color: #475569; background: #f8fafc; padding: .6rem .7rem; border-radius: 8px; border: 1px solid #e5e7eb; }

        .severity-badge { padding: .15rem .55rem; border-radius: 999px; font-size: .72rem; font-weight: 800; }
        .severity-low    { background: #dcfce7; color: #166534; }
        .severity-medium { background: #fef3c7; color: #92400e; }
        .severity-high   { background: #fee2e2; color: #991b1b; }

        .protocol-badge { padding: .15rem .4rem; border-radius: 6px; font-size: .72rem; font-weight: 800; }
        .protocol-tcp { background: #dbeafe; color: #1e40af; }
        .protocol-udp { background: #dcfce7; color: #166534; }
        .protocol-icmp { background: #fee2e2; color: #991b1b; }
        .protocol-other { background: #f3f4f6; color: #374151; }

        /* Topology */
        .topology-card { grid-column: 1 / -1; height: 560px; }
        #networkViz { width: 100%; height: 470px; background: #fafbfc; }
        .topology-controls {
            padding: .8rem 1.25rem; background: #f8fafc; border-top: 1px solid #e5e7eb;
            display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;
        }
        .control-group { display: flex; align-items: center; gap: .5rem; }
        .control-group select, .control-group input {
            padding: .45rem .6rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: .875rem;
        }
        .control-group button {
            padding: .45rem .8rem; background: #f59e0b; color: #fff; border: none; border-radius: 6px; font-size: .875rem; cursor: pointer;
        }

        /* Empty state */
        .empty-state { height: 100%; display: grid; place-items: center; text-align: center; color: #6b7280; padding: 1rem; }
        .empty-state-icon { font-size: 2.2rem; opacity: .55; margin-bottom: .4rem; }

        /* Notification */
        .notification {
            position: fixed; top: 2rem; right: 2rem; background: #fff; border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,.12); border: 1px solid #e5e7eb;
            padding: 1rem 1.1rem; max-width: 380px; z-index: 1000;
            transform: translateX(450px); transition: transform .25s ease-out;
        }
        .notification.show { transform: translateX(0); }
        .notification.alert { border-left: 4px solid #ef4444; background: linear-gradient(90deg, rgba(239,68,68,.05) 0%, #fff 20%); }
        .notification-header { display: flex; align-items: center; gap: .6rem; margin-bottom: .4rem; }
        .notification-icon { width: 36px; height: 36px; border-radius: 8px; background: #ef4444; color: #fff; display: grid; place-items: center; }
        .notification-title { margin: 0; font-weight: 800; color: #111827; }
        .notification-message { margin: 0; color: #374151; font-size: .9rem; line-height: 1.35; }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-grid { grid-template-columns: 1fr; }
            .control-grid { grid-template-columns: 1fr; }
            .btn-group .btn { width: 100%; }
        }
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header-content { flex-direction: column; text-align: center; gap: .75rem; }
            .status-badge { margin-left: 0; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">üõ°Ô∏è</div>
                <h1 class="logo-text">Enhanced IDS</h1>
            </div>
            <div class="status-badge" id="systemStatus">
                <div class="status-dot"></div><span>System Ready</span>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Control Panel -->
        <div class="control-panel">
            <div class="control-grid">
                <div class="interface-group">
                    <label for="interfaceSelect">Network Interface</label>
                    <select id="interfaceSelect" class="interface-select">
                        <option value="">Loading interfaces...</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button id="startBtn" class="btn btn-primary">üöÄ Start Monitoring</button>
                    <button id="stopBtn"  class="btn btn-danger" disabled>‚èπÔ∏è Stop Monitoring</button>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-card performance-card">
                <span class="stat-number performance" id="packetRate">0</span>
                <div class="stat-label">Packets/Second</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalPackets">0</span>
                <div class="stat-label">Total Packets</div>
            </div>
            <div class="stat-card alert-card">
                <span class="stat-number alert" id="totalAlerts">0</span>
                <div class="stat-label">Security Alerts</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="threatLevel">LOW</span>
                <div class="stat-label">Threat Level</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="activeNodes">0</span>
                <div class="stat-label">Active Nodes</div>
            </div>
            <div class="stat-card performance-card">
                <span class="stat-number performance" id="filterStats">0%</span>
                <div class="stat-label">Traffic Filtered</div>
            </div>
        </div>

        <!-- Lists -->
        <div class="main-grid">
            <div class="content-card">
                <div class="card-header alerts">
                    <h2 class="card-title">üö® Security Alerts</h2>
                    <div class="card-badge" id="alertRate">0/min</div>
                </div>
                <div class="card-content">
                    <div class="content-list" id="alertsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üõ°Ô∏è</div>
                            <div>
                                <h3>No Threats Detected</h3>
                                <p>System is monitoring for security threats</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-card">
                <div class="card-header">
                    <h2 class="card-title">üìä Network Traffic</h2>
                    <div class="card-badge" id="packetThroughput">0 PPS</div>
                </div>
                <div class="card-content">
                    <div class="content-list" id="packetsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì°</div>
                            <div>
                                <h3>No Traffic</h3>
                                <p>Start monitoring to see network activity</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topology -->
        <div class="content-card topology-card">
            <div class="card-header">
                <h2 class="card-title">üåê Network Topology</h2>
                <div class="card-badge" id="topologyStats">0 nodes</div>
            </div>
            <div class="card-content">
                <div id="networkViz"></div>
            </div>
            <div class="topology-controls">
                <div class="control-group">
                    <label>Max Nodes:</label>
                    <select id="maxNodes">
                        <option value="10">10</option>
                        <option value="15" selected>15</option>
                        <option value="20">20</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Update Rate:</label>
                    <select id="updateRate">
                        <option value="2000" selected>2s</option>
                        <option value="5000">5s</option>
                        <option value="10000">10s</option>
                    </select>
                </div>
                <div class="control-group">
                    <label><input type="checkbox" id="showLabels" checked> Show Labels</label>
                </div>
                <div class="control-group">
                    <button onclick="cleanupTopology()">üßπ Cleanup</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <div class="notification-header">
            <div class="notification-icon">‚ö†Ô∏è</div>
            <h4 class="notification-title">Security Alert</h4>
        </div>
        <p class="notification-message" id="notificationMessage">New threat detected on your network</p>
    </div>

    <script>
        console.log('üöÄ Enhanced IDS Dashboard (optimized)');

        const socket = io({ transports: ['websocket'], upgrade: true, rememberUpgrade: true });

        /* -------- State -------- */
        class IDSState {
            constructor() {
                this.isCapturing = false;
                this.stats = { packets: 0, alerts: 0, packetRate: 0, threatLevel: 'LOW', activeNodes: 0, filterStats: 0 };
                this.alertHistory = [];
                this.network = null;
                this.networkData = { nodes: new vis.DataSet(), edges: new vis.DataSet() };
            }
            updateStats(newStats) {
                this.stats = { ...this.stats, ...newStats };
                this.renderStats();
            }
            renderStats() {
                const els = {
                    packetRate: document.getElementById('packetRate'),
                    totalPackets: document.getElementById('totalPackets'),
                    totalAlerts: document.getElementById('totalAlerts'),
                    threatLevel: document.getElementById('threatLevel'),
                    activeNodes: document.getElementById('activeNodes'),
                    filterStats: document.getElementById('filterStats')
                };
                animateNumber(els.packetRate, this.stats.packetRate);
                animateNumber(els.totalPackets, this.stats.packets);
                animateNumber(els.totalAlerts, this.stats.alerts);
                els.threatLevel.textContent = this.stats.threatLevel;
                animateNumber(els.activeNodes, this.stats.activeNodes);
                els.filterStats.textContent = `${this.stats.filterStats}%`;
                document.getElementById('packetThroughput').textContent = `${this.stats.packetRate} PPS`;
                const recent = this.alertHistory.filter(a => Date.now() - a.timestamp < 60000).length;
                document.getElementById('alertRate').textContent = `${recent}/min`;
            }
        }
        const idsState = new IDSState();

        /* -------- UI Elements -------- */
        const elements = {
            interfaceSelect: document.getElementById('interfaceSelect'),
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            systemStatus: document.getElementById('systemStatus'),
            alertsList: document.getElementById('alertsList'),
            packetsList: document.getElementById('packetsList'),
            notification: document.getElementById('notification'),
            notificationMessage: document.getElementById('notificationMessage'),
            topologyStats: document.getElementById('topologyStats')
        };

        /* -------- Small helpers -------- */
        function animateNumber(el, target) {
            const current = parseInt(el.textContent) || 0;
            if (current === target) return;
            const duration = 250, steps = 12, inc = (target - current) / steps;
            let val = current, step = 0;
            const t = setInterval(() => {
                val += inc; el.textContent = Math.round(val); step++;
                if (step >= steps) { el.textContent = target; clearInterval(t); }
            }, duration / steps);
        }
        function updateSystemStatus(status, message) {
            const badge = elements.systemStatus;
            badge.className = `status-badge ${status}`;
            badge.querySelector('span').textContent = message;
        }
        function getProtocolClass(protocol) {
            const map = { TCP: 'protocol-tcp', UDP: 'protocol-udp', ICMP: 'protocol-icmp' };
            return map[protocol] || 'protocol-other';
        }

        /* -------- List manager (batched DOM) -------- */
        class SmoothListManager {
            constructor(container, maxItems = 50) {
                this.container = container;
                this.maxItems = maxItems;
                this.count = 0;
            }
            addItems(items, createItemFn) {
                if (!items || !items.length) return;
                // remove empty state once
                const empty = this.container.querySelector('.empty-state');
                if (empty) empty.remove();

                const frag = document.createDocumentFragment();
                // iterate from last to first so the first item ends up at the top after single insert
                for (let i = items.length - 1; i >= 0; i--) {
                    const el = createItemFn(items[i]);
                    frag.appendChild(el);
                    this.count++;
                }
                this.container.insertBefore(frag, this.container.firstChild);

                // trim extras in one pass
                while (this.count > this.maxItems) {
                    const last = this.container.lastElementChild;
                    if (!last) break;
                    last.remove(); this.count--;
                }
            }
            clear() {
                this.container.innerHTML = '';
                this.count = 0;
            }
        }
        const alertsManager  = new SmoothListManager(elements.alertsList, 30);
        const packetsManager = new SmoothListManager(elements.packetsList, 50);

        /* -------- Topology (diff updates + light options) -------- */
        class TopologyManager {
            constructor() {
                this.network = null;
                this.networkData = { nodes: new vis.DataSet(), edges: new vis.DataSet() };
                this.config = { maxNodes: 15, updateRate: 2000, showLabels: true };
                this.updateInterval = null;
                this.loading = false; // prevent overlapping fetches
            }
            initialize() {
                const container = document.getElementById('networkViz');
                const options = {
                    nodes: {
                        shape: 'dot', size: 18,
                        borderWidth: 2,
                        color: { background: '#10b981', border: '#059669' },
                        font: { size: 11, color: '#111827', strokeWidth: 0 },
                        shadow: false
                    },
                    edges: {
                        width: 2, color: { inherit: false },
                        smooth: false,
                        arrows: { to: { enabled: true, scaleFactor: 0.7 } },
                        shadow: false
                    },
                    physics: {
                        enabled: true,
                        stabilization: { iterations: 60, updateInterval: 20 },
                        solver: 'forceAtlas2Based',
                        forceAtlas2Based: { gravitationalConstant: -36, centralGravity: 0.005, springLength: 120, springConstant: 0.06, damping: 0.4, avoidOverlap: 0.3 }
                    },
                    interaction: { hover: false, selectConnectedEdges: false, tooltipDelay: 200, zoomView: true, dragView: true }
                };
                this.network = new vis.Network(container, this.networkData, options);
                this.startUpdates();
            }
            updateVisualization(payload) {
                if (!payload) return;
                const incomingNodes = (payload.nodes || []).slice(0, this.config.maxNodes);
                const incomingEdges = payload.edges || [];

                // Build sets for diffing
                const keepNodeIds = new Set(incomingNodes.map(n => n.id));
                const keepEdgeIds = new Set(incomingEdges.map(e => e.id));

                // Prepare node updates
                const nodeUpdates = incomingNodes.map(n => {
                    let background = '#10b981', border = '#059669';
                    if (n.is_threat) { background = '#ef4444'; border = '#dc2626'; }
                    else if (n.packet_count > 100) { background = '#f59e0b'; border = '#d97706'; }
                    const size = Math.max(14, Math.min(36, 14 + (n.packet_count / 20)));
                    return {
                        id: n.id,
                        label: this.config.showLabels ? n.id : '',
                        size,
                        color: { background, border },
                        title: `IP: ${n.id}\nPackets: ${n.packet_count}\nConnections: ${n.connections}\nStatus: ${n.is_threat ? 'THREAT' : 'Normal'}`
                    };
                });

                // Apply node updates & removals
                this.networkData.nodes.update(nodeUpdates);
                const existingNodeIds = this.networkData.nodes.getIds();
                const toRemoveNodes = existingNodeIds.filter(id => !keepNodeIds.has(id));
                if (toRemoveNodes.length) this.networkData.nodes.remove(toRemoveNodes);

                // Prepare edge updates
                const edgeUpdates = incomingEdges.map(e => {
                    const width = Math.max(2, Math.min(8, e.packet_count / 10));
                    let color = '#cbd5e1';
                    if (e.packet_count > 100) color = '#ef4444';
                    else if (e.packet_count > 30) color = '#3b82f6';
                    return {
                        id: e.id,
                        from: e.from, to: e.to, width,
                        color: { color, opacity: 0.85 },
                        title: `${e.from} ‚Üí ${e.to}\nPackets: ${e.packet_count}`
                    };
                });

                // Apply edge updates & removals
                this.networkData.edges.update(edgeUpdates);
                const existingEdgeIds = this.networkData.edges.getIds();
                const toRemoveEdges = existingEdgeIds.filter(id => !keepEdgeIds.has(id));
                if (toRemoveEdges.length) this.networkData.edges.remove(toRemoveEdges);

                // Stats
                elements.topologyStats.textContent = `${incomingNodes.length} nodes`;
                idsState.updateStats({ activeNodes: incomingNodes.length });
            }
            startUpdates() {
                this.stopUpdates();
                this.updateInterval = setInterval(() => this.loadTopologyData(), this.config.updateRate);
                this.loadTopologyData();
            }
            stopUpdates() {
                if (this.updateInterval) { clearInterval(this.updateInterval); this.updateInterval = null; }
            }
            async loadTopologyData() {
                if (this.loading) return;
                this.loading = true;
                try {
                    const res = await fetch('/api/topology/data', { cache: 'no-store' });
                    const data = await res.json();
                    this.updateVisualization(data);
                } catch (e) { console.error('Topology fetch error:', e); }
                finally { this.loading = false; }
            }
        }
        const topologyManager = new TopologyManager();

        /* -------- Socket events -------- */
        socket.on('connected', (data) => {
            console.log('‚úÖ Connected:', data.message);
            updateSystemStatus('active', 'Connected - Ready to monitor');
        });

        socket.on('packet_batch', (packets) => {
            if (packets?.length) packetsManager.addItems(packets, createPacketElement);
        });

        socket.on('alert_batch', (alerts) => {
            if (!(alerts && alerts.length)) return;
            alertsManager.addItems(alerts, createAlertElement);
            const now = Date.now();
            for (const a of alerts) idsState.alertHistory.push({ timestamp: now, severity: a.severity, alert: a });
            showNotification(alerts[0]);
            updateThreatLevel();
        });

        socket.on('stats_update', (stats) => updateStats(stats));

        socket.on('capture_error', (data) => {
            console.error('‚ùå Capture error:', data.error);
            showErrorNotification('Capture Error', data.error);
            stopCapture();
        });

        /* -------- Renderers -------- */
        function createAlertElement(alert) {
            const el = document.createElement('div');
            el.className = 'list-item alert-item';
            const sevCls = `severity-${alert.severity.toLowerCase()}`;
            el.innerHTML = `
                <div class="item-header">
                    <h4 class="item-title">${alert.rule_name}</h4>
                    <div class="severity-badge ${sevCls}">${alert.severity}</div>
                </div>
                <div class="item-time">${alert.timestamp}</div>
                <div class="item-details">${alert.description}</div>
                <div class="item-network">
                    ${alert.src_ip}${alert.src_port ? ':' + alert.src_port : ''} ‚Üí
                    ${alert.dst_ip}${alert.dst_port ? ':' + alert.dst_port : ''}
                    [${alert.protocol}] #${alert.packet_id}
                </div>`;
            return el;
        }
        function createPacketElement(packet) {
            const el = document.createElement('div');
            el.className = 'list-item packet-item';
            const proto = getProtocolClass(packet.protocol);
            el.innerHTML = `
                <div class="item-header">
                    <h4 class="item-title">#${packet.id} <span class="protocol-badge ${proto}">${packet.protocol}</span></h4>
                    <div class="item-time">${packet.timestamp}</div>
                </div>
                <div class="item-details">
                    <strong>From:</strong> ${packet.src_ip}${packet.src_port ? ':' + packet.src_port : ''} ‚Üí
                    <strong>To:</strong> ${packet.dst_ip}${packet.dst_port ? ':' + packet.dst_port : ''}
                </div>
                <div class="item-network">Size: ${packet.size} bytes${packet.flags ? ' | Flags: ' + packet.flags : ''}</div>`;
            return el;
        }

        /* -------- Stats & threat level -------- */
        function updateStats(newStats) {
            const stats = {
                packets: newStats.packets || 0,
                alerts: newStats.alerts || 0,
                packetRate: newStats.packets_per_second || 0,
                activeNodes: idsState.stats.activeNodes,
                filterStats: newStats?.filter_stats?.blocked_percentage || 0
            };
            idsState.updateStats(stats);
        }
        function updateThreatLevel() {
            const windowMs = 5 * 60 * 1000;
            const recent = idsState.alertHistory.filter(a => Date.now() - a.timestamp < windowMs);
            const high = recent.filter(a => a.severity === 'High').length;
            let level = 'LOW';
            if (high >= 5 || recent.length >= 20) level = 'CRITICAL';
            else if (high >= 2 || recent.length >= 10) level = 'HIGH';
            else if (high >= 1 || recent.length >= 5) level = 'MEDIUM';
            idsState.updateStats({ threatLevel: level });
        }

        /* -------- Notifications -------- */
        function showNotification(alert) {
            elements.notificationMessage.textContent = `${alert.rule_name}: ${alert.src_ip} ‚Üí ${alert.dst_ip}`;
            elements.notification.classList.add('show', 'alert');
            playNotificationSound();
            setTimeout(() => elements.notification.classList.remove('show'), 5000);
        }
        function showErrorNotification(title, message) {
            elements.notification.querySelector('.notification-title').textContent = title;
            elements.notificationMessage.textContent = message;
            elements.notification.classList.add('show');
            setTimeout(() => elements.notification.classList.remove('show'), 5000);
        }
        function playNotificationSound() {
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator(); const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.frequency.value = 800; osc.type = 'sine';
                gain.gain.setValueAtTime(0.08, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
                osc.start(); osc.stop(ctx.currentTime + 0.25);
            } catch {}
        }

        /* -------- Interfaces & capture -------- */
        async function loadInterfaces() {
            try {
                const res = await fetch('/interfaces', { cache: 'no-store' });
                const interfaces = await res.json();
                elements.interfaceSelect.innerHTML = '<option value="">Select interface...</option>';
                interfaces.forEach(iface => {
                    const o = document.createElement('option');
                    o.value = iface.ip; o.textContent = `${iface.name} (${iface.ip})`;
                    elements.interfaceSelect.appendChild(o);
                });
            } catch (e) {
                console.error('Interfaces error:', e);
                elements.interfaceSelect.innerHTML = '<option value="">Failed to load interfaces</option>';
            }
        }
        async function startCapture() {
            const ip = elements.interfaceSelect.value;
            if (!ip) { showErrorNotification('Interface Required', 'Please select a network interface'); return; }
            try {
                const res = await fetch('/start_capture', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interface_ip: ip })
                });
                const data = await res.json();
                if (data.success) {
                    idsState.isCapturing = true;
                    elements.startBtn.disabled = true; elements.stopBtn.disabled = false; elements.interfaceSelect.disabled = true;
                    updateSystemStatus('active', 'Monitoring Active - Enhanced IDS Running');
                    alertsManager.clear(); packetsManager.clear();
                    topologyManager.startUpdates();
                } else showErrorNotification('Start Failed', data.message);
            } catch (e) { console.error('Start error:', e); showErrorNotification('Connection Error', e.message); }
        }
        async function stopCapture() {
            try {
                await fetch('/stop_capture', { method: 'POST' });
                idsState.isCapturing = false;
                elements.startBtn.disabled = false; elements.stopBtn.disabled = true; elements.interfaceSelect.disabled = false;
                updateSystemStatus('inactive', 'Monitoring Stopped');
                topologyManager.stopUpdates();
            } catch (e) { console.error('Stop error:', e); }
        }

        /* -------- Topology controls -------- */
        function cleanupTopology() {
            fetch('/api/topology/cleanup', { method: 'POST' })
                .then(r => r.json())
                .then(() => topologyManager.loadTopologyData())
                .catch(e => console.error('Cleanup error:', e));
        }

        /* -------- Events -------- */
        elements.startBtn.addEventListener('click', startCapture);
        elements.stopBtn .addEventListener('click', stopCapture);
        document.getElementById('maxNodes').addEventListener('change', (e) => {
            topologyManager.config.maxNodes = parseInt(e.target.value, 10);
            topologyManager.loadTopologyData();
        });
        document.getElementById('updateRate').addEventListener('change', (e) => {
            topologyManager.config.updateRate = parseInt(e.target.value, 10);
            topologyManager.startUpdates();
        });
        document.getElementById('showLabels').addEventListener('change', (e) => {
            topologyManager.config.showLabels = e.target.checked;
            topologyManager.loadTopologyData();
        });

        /* -------- Init -------- */
        window.addEventListener('load', async () => {
            await loadInterfaces();
            topologyManager.initialize();
            updateSystemStatus('inactive', 'System Ready - Select interface to start');
            console.log('‚úÖ Dashboard ready (optimized)');
        });
        window.addEventListener('beforeunload', () => topologyManager.stopUpdates());
    </script>
</body>
</html>
